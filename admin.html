<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدرسة - منصة تعليمية آمنة</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">منصة المدرسة - لوحة الإدارة</div>
            <a href="index.html" class="btn-secondary"
                style="padding: 10px 20px; text-decoration: none; border-radius: 8px;">معاينة كطالب</a>
        </header>

        <main>
            <section class="card">
                <h2 style="margin-bottom: 20px;">إضافة درس جديد</h2>
                <form id="lessonForm">
                    <div class="form-group">
                        <label>عنوان الدرس</label>
                        <input type="text" id="lessonTitle" placeholder="مثال: فيزياء - الوحدة الأولى" required>
                    </div>
                    <div class="form-group">
                        <label>رابط جوجل درايف (رابط المشاركة أو التضمين)</label>
                        <input type="url" id="lessonLink" placeholder="https://drive.google.com/file/d/.../view"
                            required>
                        <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                            <strong>مهم جداً:</strong> تأكد من ضبط إعدادات المشاركة في جوجل درايف لتكون "Anyone with the
                            link can view".
                            سيتكفل النظام بتحويل الرابط تلقائياً إلى رابط صالح للتشغيل.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>كود الحصة (15 حرف ورقم)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="lessonCode" readonly required>
                            <button type="button" onclick="generateCode()" style="width: auto;">توليد كود</button>
                        </div>
                    </div>
                    <button type="submit">إضافة الدرس للمنصة</button>
                </form>
            </section>

            <section class="card">
                <h2 style="margin-bottom: 20px;">الدروس الحالية</h2>
                <div id="lessonList">
                    <!-- Lessons will be listed here -->
                </div>
            </section>
        </main>
    </div>

    <script src="security.js"></script>
    <script>
        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 15; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('lessonCode').value = code;
        }

        const lessons = JSON.parse(localStorage.getItem('school_lessons') || '[]');

        function renderLessons() {
            const list = document.getElementById('lessonList');
            list.innerHTML = lessons.length ? '' : '<p style="color: var(--text-muted);">لا توجد دروس مضافة حالياً.</p>';

            lessons.forEach((lesson, index) => {
                const item = document.createElement('div');
                item.className = 'card';
                item.style.marginBottom = '10px';
                item.style.padding = '15px';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${lesson.title}</strong><br>
                            <span style="font-size: 0.8rem; color: var(--primary);">كود الدخول: ${lesson.code}</span>
                        </div>
                        <button onclick="deleteLesson(${index})" style="width: auto; background: #ff4444; padding: 5px 15px;">حذف</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function formatDriveLink(url) {
            // Convert sharing links to preview links
            try {
                let formatted = url.trim();
                if (formatted.includes('drive.google.com')) {
                    // Extract ID
                    const match = formatted.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        return `https://drive.google.com/file/d/${match[1]}/preview`;
                    }
                }
                return formatted;
            } catch (e) {
                return url;
            }
        }

        document.getElementById('lessonForm').onsubmit = (e) => {
            e.preventDefault();
            const title = document.getElementById('lessonTitle').value;
            let link = document.getElementById('lessonLink').value;
            const code = document.getElementById('lessonCode').value;

            if (!code) {
                alert("يرجى توليد كود الحصة أولاً.");
                return;
            }

            link = formatDriveLink(link);

            lessons.push({ id: Date.now(), title, link, code });
            localStorage.setItem('school_lessons', JSON.stringify(lessons));

            e.target.reset();
            renderLessons();
            alert("تم إضافة الدرس بنجاح! تم تحسين رابط جوجل درايف تلقائياً.");
        };

        function deleteLesson(index) {
            if (confirm("هل أنت متأكد من حذف هذا الدرس؟")) {
                lessons.splice(index, 1);
                localStorage.setItem('school_lessons', JSON.stringify(lessons));
                renderLessons();
            }
        }

        renderLessons();
    </script>
</body>

</html>