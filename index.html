<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الطلاب - احمد </title>
    <link rel="stylesheet" href="style.css">
    <style>
        #playerSection {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 10000;
            padding: 20px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10001;
            width: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">بوابة الطالب التعليمية</div>
            <a href="admin.html" class="btn-secondary"
                style="padding: 10px 20px; text-decoration: none; border-radius: 8px;">لوحة المعلم</a>
        </header>

        <main>
            <h2 style="margin-bottom: 20px;">الدروس المتاحة</h2>
            <div id="studentLessonList" class="lesson-grid">
                <!-- Lessons for students -->
            </div>
        </main>
    </div>

    <!-- Video Modal / Section -->
    <div id="playerSection">
        <button class="back-btn" onclick="closePlayer()">إغلاق الدرس</button>
        <div class="container" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <h2 id="currentLessonTitle" style="margin-bottom: 20px; text-align: center;"></h2>
            <div class="video-wrapper" id="videoWrapper">
                <iframe id="videoPlayer" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div style="margin-top: 20px; text-align: center; color: var(--text-muted);">
                <p>ملاحظة: سيتم تشويش الفيديو إذا قمت بمغادرة الصفحة أو تصغيرها.</p>
            </div>
        </div>
    </div>

    <script src="security.js"></script>
    <script>
        const lessons = JSON.parse(localStorage.getItem('school_lessons') || '[]');

        function renderStudentLessons() {
            const grid = document.getElementById('studentLessonList');
            grid.innerHTML = lessons.length ? '' : '<p style="color: var(--text-muted);">لا توجد دروس متاحة حالياً.</p>';

            lessons.forEach((lesson) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.onclick = () => promptAccess(lesson);
                card.innerHTML = `
                    <div style="height: 150px; background: var(--glass); border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="var(--primary)"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <h3 style="font-size: 1.1rem;">${lesson.title}</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">اضغط للمشاهدة</p>
                `;
                grid.appendChild(card);
            });
        }

        function promptAccess(lesson) {
            const code = prompt("يرجى إدخال كود الحصة المكون من 15 حرفاً:");
            if (code === lesson.code) {
                // Show safety check BEFORE opening
                Security.showSafetyCheck(() => {
                    openPlayer(lesson, code);
                });
            } else if (code !== null) {
                alert("الكود غير صحيح! يرجى التأكد من الكود الذي أعطاه لك المعلم.");
            }
        }

        function formatDriveLink(url) {
            if (url.includes('drive.google.com') && !url.includes('/preview')) {
                const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    return `https://drive.google.com/file/d/${match[1]}/preview`;
                }
            }
            return url;
        }

        function openPlayer(lesson, code) {
            const player = document.getElementById('videoPlayer');
            const title = document.getElementById('currentLessonTitle');

            title.textContent = lesson.title;
            player.src = formatDriveLink(lesson.link);
            document.getElementById('playerSection').style.display = 'block';

            // Start Security Measures
            Security.startWatermark(code);
        }

        // Expose closePlayer globally so security.js can call it
        window.closePlayer = function () {
            document.getElementById('playerSection').style.display = 'none';
            document.getElementById('videoPlayer').src = '';
            Security.stopWatermark();
        };

        renderStudentLessons();
    </script>
</body>

</html>